<script>
const form = document.getElementById('botForm');
const output = document.getElementById('output');

// Determine correct Netlify function paths
const createBotPath = window.location.hostname.includes('localhost')
  ? '/netlify/functions/overpoweredbot'
  : '/.netlify/functions/overpoweredbot';

const generateExplorePath = window.location.hostname.includes('localhost')
  ? '/netlify/functions/generateExplore'
  : '/.netlify/functions/generateExplore';

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const description = document.getElementById('description').value.trim();

  if (!description) {
    output.textContent = 'Please enter a description.';
    output.className = 'output error';
    return;
  }

  output.textContent = 'Creating bot...';
  output.className = 'output';

  try {
    // Step 1: Create the bot
    const res = await fetch(createBotPath, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ description })
    });

    const data = await res.json();

    if (!res.ok || data.error) {
      output.textContent = `Error creating bot: ${data.error || 'Unknown error'}`;
      output.className = 'output error';
      return;
    }

    // Step 2: Regenerate explore.html
    output.textContent = 'Generating Explore page...';
    const exploreRes = await fetch(generateExplorePath, { method: 'POST' });
    const exploreData = await exploreRes.text(); // we can ignore content, just trigger generation

    if (!exploreRes.ok) {
      console.warn("⚠️ Explore page generation failed.");
    }

    // Step 3: Success
    output.innerHTML = `
      <strong>Bot Created Successfully!</strong><br>
      ID/Hash: ${data.hash || 'N/A'}<br>
      API Key: ${data.apiKey || 'Check Supabase'}<br>
      File: bot.js
    `;
    output.className = 'output success';
    form.reset();

    // Optional: Redirect to Explore page after creation
    setTimeout(() => {
      window.location.href = '/explore.html'; // make sure this matches your deployed path
    }, 1000);

  } catch (err) {
    console.error(err);
    output.textContent = 'Failed to create bot.';
    output.className = 'output error';
  }
});
</script>
